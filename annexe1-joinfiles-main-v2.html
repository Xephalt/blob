<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annexe – JoinFiles.sh (Orchestrateur maître) – Version améliorée</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }
        
        h1 {
            color: #1a5490;
            border-bottom: 4px solid #1a5490;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        h2 {
            color: #2980b9;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-left: 5px solid #2980b9;
            padding-left: 15px;
        }
        
        h3 {
            color: #3498db;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .intro {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }
        
        /* Code blocks avec coloration syntaxique */
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            border-left: 5px solid #ff9800;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.7;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 1px 3px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            position: relative;
        }
        
        .code-block code {
            background: none;
            padding: 0;
            border-radius: 0;
            color: #d4d4d4;
            font-size: 13px;
            display: block;
            white-space: pre;
            word-break: normal;
            word-wrap: normal;
        }
        
        .code-block::before {
            content: "sh";
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 11px;
            color: #666;
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* Coloration syntaxique */
        .k { color: #569cd6; font-weight: bold; }        /* keywords */
        .s { color: #ce9178; }                            /* strings */
        .c { color: #6a9955; font-style: italic; }       /* comments */
        .v { color: #9cdcfe; }                           /* variables */
        .f { color: #dcdcaa; }                           /* functions */
        .n { color: #b5cea8; }                           /* numbers */
        .o { color: #d4d4d4; }                           /* operators */
        
        .section-block {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
        }
        
        .highlight-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning::before {
            content: "⚠️ ";
            font-weight: bold;
        }
        
        ul, ol {
            margin-left: 25px;
            margin-bottom: 20px;
        }
        
        li {
            margin-bottom: 10px;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            color: #d32f2f;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: #2980b9;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .flow-diagram {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Annexe – JoinFiles.sh</h1>
        <h2 style="margin-top: 0; border: none; padding: 0; color: #666; font-size: 1.4em;">Orchestrateur maître du pipeline ETL</h2>
        
        <div class="intro">
            <p><strong>JoinFiles.sh</strong> est le <strong>script maître</strong> qui orchestre tout le pipeline de transformation ETL. Il :</p>
            <ul>
                <li>✓ Déchiffre tous les fichiers GPG</li>
                <li>✓ Extrait l'archive ELOQUA</li>
                <li>✓ Lance les deux processus parallèles (EdJad et Refog)</li>
                <li>✓ Effectue la jointure finale</li>
                <li>✓ Nettoie les fichiers intermédiaires</li>
            </ul>
        </div>
        
        <h2>1. Fonction principale – run()</h2>
        
        <div class="code-block"><code><span class="k">run</span>() {
  <span class="f">echo</span> <span class="s">"$(date +%Y%m%d-%H%M%S) Starting JoinFiles job"</span>
  <span class="f">pwd</span>
  <span class="f">ls</span> -la

  <span class="k">if</span> [ <span class="s">"$1"</span> != <span class="s">"test"</span> ]; <span class="k">then</span>
    <span class="f">uncypher_all_files</span>
    <span class="f">unzip_file</span> <span class="s">"$ELOQUA_ZIPPED_FILE"</span>
  <span class="k">else</span>
    <span class="f">echo</span> <span class="s">"Mode test : pas de déchiffrement"</span>
  <span class="k">fi</span>

  <span class="f">processEdjad</span>
  <span class="f">processRefog</span>
  <span class="f">joinEdjadToRefog</span>
  <span class="f">cleanupFiles</span>

  <span class="f">echo</span> <span class="s">"$(date +%Y%m%d-%H%M%S) End of JoinFiles job"</span>
}

<span class="c"># Appel du script avec paramètre optionnel</span>
<span class="f">run</span> <span class="s">"$1"</span></code></div>
        
        <div class="highlight-box">
            <strong>▶ Orchestration du flux :</strong>
            <ol>
                <li>Affichage du contexte (timestamp, répertoire, listing)</li>
                <li>Déchiffrement GPG (optionnel avec paramètre "test")</li>
                <li>Extraction archive ELOQUA</li>
                <li>Lancement processEdjad (enrichissement métier RH)</li>
                <li>Lancement processRefog (consolidation structure)</li>
                <li>Jointure des deux résultats</li>
                <li>Nettoyage des fichiers temporaires</li>
            </ol>
        </div>
        
        <h2>2. Déchiffrement GPG – uncypher_all_files()</h2>
        
        <div class="code-block"><code><span class="f">uncypher_all_files</span>() {
  <span class="f">echo</span> <span class="s">"Déchiffrement de tous les fichiers"</span>

  <span class="f">uncypher_file</span> <span class="s">"$ELOQUA_CYPHERED_FILE"</span> <span class="s">"$ELOQUA_ZIPPED_FILE"</span>

  <span class="f">uncypher_file</span> <span class="s">"$IMMEUBLE_CYPHERED_FILE"</span> <span class="s">"Immeuble.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$PERSONNE_CYPHERED_FILE"</span> <span class="s">"Personne.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$PERSONNE_CYPHERED_FILE_DESACT"</span> <span class="s">"PersonneDesact.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$UO_CYPHERED_FILE"</span> <span class="s">"UO.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$UO_HIERARCHIQUE_CYPHERED_FILE"</span> <span class="s">"UOHierarchique.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$FILIERES_CYPHERED_FILE"</span> <span class="s">"Filiere.csv"</span>
  <span class="f">uncypher_file</span> <span class="s">"$SOUS_FILIERES_CYPHERED_FILE"</span> <span class="s">"SousFiliere.csv"</span>
}</code></div>
        
        <div class="info-box">
            <strong>✓ Objectif :</strong> Déchiffrer tous les fichiers .gpg en CSV clairs
            <br><br>
            <strong>✓ Flux :</strong>
            <ul>
                <li>Archive ELOQUA → déchiffrement → ELOQUA.zip (compressé)</li>
                <li>8 fichiers de référence → déchiffrement → CSV clairs</li>
            </ul>
            <strong>✓ Utilité :</strong> Sécurité au repos + traitement en clair
        </div>
        
        <h2>3. Jointure finale – joinEdjadToRefog()</h2>
        
        <div class="code-block"><code><span class="f">joinEdjadToRefog</span>() {
  <span class="f">echo</span> <span class="s">"Jointure EdJad → Refog"</span>

  <span class="c"># Suppression des en-têtes pour la jointure</span>
  <span class="f">sed</span> -i <span class="s">'1d'</span> <span class="s">"$REFOG_OUTPUT_FILE"</span>
  <span class="f">sed</span> -i <span class="s">'1d'</span> <span class="s">"$EDJAD_OUTPUT_FILE"</span>

  <span class="c"># Tri par première colonne (UID) pour la jointure</span>
  <span class="f">sort</span> -t<span class="s">";"</span> -k1 <span class="s">"$REFOG_OUTPUT_FILE"</span> <span class="o">></span> sorted_refog.csv
  <span class="f">sort</span> -t<span class="s">";"</span> -k1 <span class="s">"$EDJAD_OUTPUT_FILE"</span> <span class="o">></span> sorted_edjad.csv

  <span class="c"># Construction dynamique : 46 colonnes Refog + 27 colonnes EdJad</span>
  <span class="v">REFOG_FIELDS</span>=<span class="s">"$(for i in $(seq 1 46); do echo -n "1.$i,"; done | sed 's/,$//')"</span>
  <span class="v">EDJAD_FIELDS</span>=<span class="s">"$(for i in $(seq 2 28); do echo -n "2.$i,"; done | sed 's/,$//')"</span>

  <span class="c"># Jointure par UID (colonne 1)</span>
  <span class="f">join</span> -t<span class="s">";"</span> \
    -o <span class="s">"$REFOG_FIELDS,$EDJAD_FIELDS"</span> \
    -1 1 -2 1 \
    sorted_refog.csv sorted_edjad.csv \
    <span class="o">></span> TMP_ImportRefog.csv

  <span class="f">mv</span> TMP_ImportRefog.csv <span class="s">"$REFOG_OUTPUT_FILE"</span>
  <span class="f">rm</span> -f sorted_refog.csv sorted_edjad.csv
}</code></div>
        
        <div class="highlight-box">
            <strong>▶ Ce que fait la jointure :</strong>
            <ol>
                <li><strong>Suppression en-têtes :</strong> Garde seulement les données</li>
                <li><strong>Tri par UID :</strong> Colonne 1 pour algorithm join</li>
                <li><strong>Jointure :</strong> Combine 46 colonnes Refog + 27 colonnes EdJad = 73 finales</li>
                <li><strong>Résultat :</strong> ImportRefog.csv enrichi de la nomenclature RH</li>
            </ol>
        </div>
        
        <h2>4. Nettoyage – cleanupFiles()</h2>
        
        <div class="code-block"><code><span class="f">cleanupFiles</span>() {
  <span class="f">echo</span> <span class="s">"Nettoyage des fichiers intermédiaires"</span>

  <span class="f">ls</span> | <span class="k">while</span> <span class="f">read</span> file; <span class="k">do</span>
    <span class="k">case</span> <span class="s">"$file"</span> <span class="k">in</span>
      *.sh|<span class="s">"$REFOG_OUTPUT_FILE"</span>|<span class="s">"$REFOG_OUTPUT_FILE_DESACT"</span>|<span class="s">"$REFOG_OUTPUT_FILE_DESACT_OLD"</span>)
        <span class="f">echo</span> <span class="s">"$file conservé"</span>
        ;;
      *)
        <span class="f">rm</span> -f <span class="s">"$file"</span>
        ;;
    <span class="k">esac</span>
  <span class="k">done</span>
}</code></div>
        
        <div class="warning">
            <strong>Conservés :</strong> <code>*.sh</code>, <code>ImportRefog.csv</code>, <code>ImportRefogDesact.csv</code>, <code>ImportRefogDesactVieille.csv</code>
            <br><br>
            <strong>Supprimés :</strong> Tous les autres fichiers (sources, temporaires, Import_EdJad.csv, etc.)
        </div>
        
        <h2>5. Variables globales</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Catégorie</th>
                    <th>Variable</th>
                    <th>Valeur</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: #e3f2fd;">
                    <td colspan="3" style="background: #bbdefb; font-weight: bold;">ENTRÉES (fichiers chiffrés)</td>
                </tr>
                <tr>
                    <td>Chiffrement</td>
                    <td><code>ELOQUA_CYPHERED_FILE</code></td>
                    <td>ELOQUA.zip.gpg (archive)</td>
                </tr>
                <tr>
                    <td>Chiffrement</td>
                    <td><code>IMMEUBLE_CYPHERED_FILE</code></td>
                    <td>Immeuble.csv.gpg</td>
                </tr>
                <tr>
                    <td>Chiffrement</td>
                    <td><code>PERSONNE_CYPHERED_FILE</code></td>
                    <td>Personne.csv.gpg</td>
                </tr>
                <tr>
                    <td>Chiffrement</td>
                    <td><code>UO_CYPHERED_FILE</code></td>
                    <td>UO.csv.gpg</td>
                </tr>
                <tr style="background: #e8f5e9;">
                    <td colspan="3" style="background: #c8e6c9; font-weight: bold;">SORTIES (fichiers finaux)</td>
                </tr>
                <tr>
                    <td>Sortie</td>
                    <td><code>REFOG_OUTPUT_FILE</code></td>
                    <td>ImportRefog.csv (FINAL enrichi)</td>
                </tr>
                <tr>
                    <td>Sortie</td>
                    <td><code>REFOG_OUTPUT_FILE_DESACT</code></td>
                    <td>ImportRefogDesact.csv (delta)</td>
                </tr>
                <tr>
                    <td>Sortie</td>
                    <td><code>EDJAD_OUTPUT_FILE</code></td>
                    <td>Import_EdJad.csv (intermédiaire, supprimé)</td>
                </tr>
            </tbody>
        </table>
        
        <h2>6. Erreurs – set -e</h2>
        
        <div class="info-box">
            <strong>set -e :</strong> Le script s'arrête immédiatement si une commande échoue
            <br><br>
            <strong>Avantage :</strong> Évite de continuer avec des données partielles ou corrompues
            <br><br>
            <strong>end_if_error() :</strong> Fonction pour afficher messages + timestamp + code erreur avant exit
        </div>

                <div class="flow-diagram">
┌─────────────────────────┐
│    Fichiers chiffrés    │
│  (.csv.gpg, .zip.gpg)   │
└────────────┬────────────┘
             │
             ▼
    ┌───────────────────┐
    │ uncypher_all_    │
    │    files()        │
    └───────────┬───────┘
                │
                ▼
    ┌───────────────────┐
    │   unzip_file()    │
    └────────┬──────────┘
             │
      ┌──────┴──────┐
      │             │
      ▼             ▼
 processEdjad  processRefog
      │             │
      ▼             ▼
    Import_    ImportRefog.csv
    EdJad.csv  ImportRefogDesact.csv
      │             │
      └──────┬──────┘
             │
             ▼
    ┌──────────────────┐
    │joinEdjadToRefog()│
    └────────┬─────────┘
             │
             ▼
    ImportRefog.csv (FINAL enrichi)
             │
             ▼
    ┌──────────────────┐
    │  cleanupFiles()  │
    └────────┬─────────┘
             │
             ▼
      Répertoire nettoyé
      (seules les sorties finales)
        
        <div class="footer">
            <p>Annexe détaillée – JoinFiles.sh</p>
            <p style="margin-top: 5px; color: #95a5a6;">Orchestrateur maître du pipeline ETL</p>
        </div>
    </div>
</body>
</html>
